<div class="product-page container-fluid py-4 px-3 px-lg-5 bg-body-tertiary min-vh-100">

  <!-- Header -->
  <header class="page-header d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4">
    <div>
      <h1 class="fw-bold fs-3 mb-1 text-dark">Quản lý Product</h1>
      <p class="text-muted mb-0">Quản lý sản phẩm theo danh mục (Category)</p>
    </div>

    <button class="btn btn-primary btn-lg shadow-sm d-flex align-items-center gap-2" (click)="openModal()">
      <i class="bi bi-plus-circle"></i>
      <span>Thêm Product</span>
    </button>
  </header>

  <!-- Toolbar -->
  <section class="toolbar card border-0 shadow-sm mb-4 rounded-4">
    <div class="card-body d-flex flex-wrap gap-3 align-items-center justify-content-between">
      <div class="d-flex flex-wrap gap-3 align-items-center w-100">

        <div class="input-group search-box shadow-sm" style="max-width: 260px;">
          <span class="input-group-text bg-white border-end-0">
            <i class="bi bi-search text-secondary"></i>
          </span>
          <input
            type="text"
            class="form-control border-start-0"
            placeholder="Tìm kiếm theo tên..."
            [(ngModel)]="filterName"
          />
        </div>

        <select class="form-select shadow-sm" style="min-width: 200px;" [(ngModel)]="filterCategory">
          <option [ngValue]="null">-- Tất cả Category --</option>
          <option *ngFor="let c of categories" [ngValue]="c">{{ c.name }}</option>
        </select>

        <select class="form-select shadow-sm" style="min-width: 160px;" [(ngModel)]="sortField">
          <option value="name">Tên sản phẩm</option>
          <option value="base_price">Giá cơ bản</option>
        </select>

        <select class="form-select shadow-sm" style="min-width: 140px;" [(ngModel)]="sortDirection">
          <option value="asc">Tăng dần</option>
          <option value="desc">Giảm dần</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Empty -->
  <div *ngIf="!filteredProducts().length" class="text-center py-5 text-muted">
    <i class="bi bi-box-seam text-secondary fs-1 d-block mb-3"></i>
    <div class="fs-5">Không có sản phẩm nào phù hợp</div>
  </div>

  <!-- Product Table -->
  <section *ngIf="filteredProducts().length" class="card border-0 shadow-sm rounded-4 overflow-hidden">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light text-muted text-uppercase small">
          <tr>
            <th class="ps-4">Ảnh</th>
            <th>SKU</th>
            <th>Tên sản phẩm</th>
            <th>Danh mục</th>
            <th>Giá cơ bản</th>
            <th>Trạng thái</th>
            <th class="text-end pe-4">Hành động</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of filteredProducts()" class="transition-hover">
            <td class="ps-4">
              <img
                *ngIf="p.image_url"
                [src]="p.image_url"
                alt="{{ p.name }}"
                class="rounded-3 shadow-sm"
                style="height: 60px; width: auto;"
              />
              <span *ngIf="!p.image_url" class="text-muted small">—</span>
            </td>
            <td class="fw-semibold text-dark">{{ p.sku }}</td>
            <td>{{ p.name }}</td>
            <td>{{ p.category?.name || '-' }}</td>
            <td>{{ p.base_price | number: '1.0-0' }} ₫</td>
            <td>
              <span
                class="badge rounded-pill px-3 py-2"
                [ngClass]="p.is_active ? 'bg-success' : 'bg-secondary'"
              >
                {{ p.is_active ? 'Active' : 'Inactive' }}
              </span>
            </td>
            <td class="text-end pe-4">
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" (click)="editProduct(p)" title="Sửa">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" (click)="deleteProduct(p)" title="Xóa">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Modal -->
  <div class="modal fade" tabindex="-1" [ngClass]="{ show: modalOpen }" [style.display]="modalOpen ? 'block' : 'none'">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content border-0 shadow-lg rounded-4">
        <div class="modal-header bg-body-secondary border-0 rounded-top-4">
          <h5 class="modal-title fw-bold mb-0">
            <i class="bi bi-pencil-square me-2 text-primary"></i>
            {{ editingProduct ? 'Sửa Product' : 'Tạo Product mới' }}
          </h5>
          <button type="button" class="btn-close" (click)="closeModal()"></button>
        </div>

        <div class="modal-body p-4">
          <form (ngSubmit)="saveProduct()">

            <div class="row g-3">
              <div class="col-md-6">
                <label for="sku" class="form-label fw-semibold">SKU</label>
                <input id="sku" type="text" [(ngModel)]="product.sku" name="sku" class="form-control form-control-lg shadow-sm">
              </div>

              <div class="col-md-6">
                <label for="name" class="form-label fw-semibold">Tên sản phẩm</label>
                <input id="name" type="text" [(ngModel)]="product.name" name="name" class="form-control form-control-lg shadow-sm" required>
              </div>

              <div class="col-md-6">
                <label for="category" class="form-label fw-semibold">Danh mục</label>
                <select id="category" [(ngModel)]="product.category" name="category" class="form-select form-select-lg shadow-sm">
                  <option [ngValue]="null">-- Không có --</option>
                  <option *ngFor="let c of categories" [ngValue]="c">{{ c.name }}</option>
                </select>
              </div>

              <div class="col-md-6">
                <label for="base_price" class="form-label fw-semibold">Giá cơ bản (₫)</label>
                <input id="base_price" type="number" step="0.01" [(ngModel)]="product.base_price" name="base_price" class="form-control form-control-lg shadow-sm" required>
              </div>

              <div class="col-12">
                <label for="description" class="form-label fw-semibold">Mô tả</label>
                <textarea id="description" [(ngModel)]="product.description" name="description" class="form-control form-control-lg shadow-sm" rows="3"></textarea>
              </div>

              <div class="col-12">
                <label for="img" class="form-label fw-semibold">Ảnh</label>
                <input type="file" id="img" class="form-control shadow-sm" (change)="onFileSelected($event)" />
                <div *ngIf="product.image_url" class="mt-2">
                  <img [src]="product.image_url" alt="Preview" class="img-thumbnail rounded-3 shadow-sm" style="max-height: 120px;">
                </div>
              </div>

              <div class="col-12 form-check mt-3">
                <input class="form-check-input" type="checkbox" [(ngModel)]="product.is_active" name="is_active" id="is_active">
                <label class="form-check-label fw-semibold" for="is_active">Kích hoạt sản phẩm</label>
              </div>
            </div>

            <div class="d-flex justify-content-end gap-2 mt-4">
              <button type="submit" class="btn btn-primary px-4">
                <i class="bi bi-check-circle me-1"></i> Lưu
              </button>
              <button type="button" class="btn btn-outline-secondary px-4" (click)="closeModal()">
                <i class="bi bi-x-circle me-1"></i> Hủy
              </button>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>

</div>
