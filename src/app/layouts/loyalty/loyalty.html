<div class="loyalty-page container-fluid py-4 px-3 px-lg-5 bg-body-tertiary min-vh-100">

  <!-- Header -->
  <header class="page-header d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4">
    <div>
      <h1 class="fw-bold fs-3 mb-1 text-dark">Quản lý Loyalty</h1>
      <p class="text-muted mb-0">Theo dõi quy tắc, tài khoản và giao dịch điểm thưởng.</p>
    </div>
  </header>

  <!-- Tabs -->
  <section class="toolbar card border-0 shadow-sm mb-4 rounded-4">
    <div class="card-body d-flex flex-wrap gap-3 align-items-center justify-content-between">
      <div class="nav nav-pills gap-2">
        <button class="btn btn-outline-primary px-4 py-2"
          [class.active]="viewMode === 'rules'"
          (click)="openMode('rules')">
          Quy tắc
        </button>
        <button class="btn btn-outline-primary px-4 py-2"
          [class.active]="viewMode === 'accounts'"
          (click)="openMode('accounts')">
          Tài khoản
        </button>
        <button class="btn btn-outline-primary px-4 py-2"
          [class.active]="viewMode === 'transactions'"
          (click)="openMode('transactions')">
          Giao dịch
        </button>
      </div>

      <button *ngIf="viewMode === 'rules'"
        class="btn btn-primary btn-lg shadow-sm d-flex align-items-center gap-2"
        (click)="openModal()">
        <i class="bi bi-plus-circle"></i>
        <span>Thêm quy tắc</span>
      </button>
    </div>
  </section>

  <!-- ==================== RULES ==================== -->
  <section *ngIf="viewMode === 'rules'" class="card border-0 shadow-sm rounded-4 overflow-hidden">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light text-muted text-uppercase small">
          <tr>
            <th class="ps-4">Tầng</th>
            <th>Điểm tối thiểu</th>
            <th>Giảm giá (%)</th>
            <th>Mô tả</th>
            <th class="text-end pe-4">Hành động</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of rules">
            <td class="ps-4 fw-semibold text-dark">{{ r.tier_name }}</td>
            <td>{{ r.min_points }}</td>
            <td>{{ r.multiplier }}%</td>
            <td>{{ r.description }}</td>
            <td class="text-end pe-4">
              <button class="btn btn-sm btn-outline-primary me-1" (click)="editRule(r)" title="Sửa">
                <i class="bi bi-pencil-square"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" (click)="deleteRule(r.id)" title="Xóa">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
          <tr *ngIf="rules.length === 0">
            <td colspan="5" class="text-center py-4 text-muted">
              <i class="bi bi-inbox text-secondary fs-4 d-block mb-2"></i>
              Không có dữ liệu
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- ==================== ACCOUNTS ==================== -->
  <section *ngIf="viewMode === 'accounts'" class="card border-0 shadow-sm rounded-4 overflow-hidden">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light text-muted text-uppercase small">
          <tr>
            <th class="ps-4">User ID</th>
            <th>Điểm</th>
            <th>Tầng</th>
            <th>Quy tắc</th>
            <th class="pe-4 text-end">Cập nhật</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let a of accounts">
            <td class="ps-4 fw-semibold text-dark">{{ a.user_id }}</td>
            <td>{{ a.points }}</td>
            <td>{{ a.tier }}</td>
            <td>{{ a.loyalty_rule_id }}</td>
            <td class="text-end pe-4">{{ a.updated_at | date:'short' }}</td>
          </tr>
          <tr *ngIf="accounts.length === 0">
            <td colspan="5" class="text-center py-4 text-muted">
              <i class="bi bi-inbox text-secondary fs-4 d-block mb-2"></i>
              Không có dữ liệu
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- ==================== TRANSACTIONS ==================== -->
  <section *ngIf="viewMode === 'transactions'" class="card border-0 shadow-sm rounded-4 overflow-hidden">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light text-muted text-uppercase small">
          <tr>
            <th class="ps-4">ID</th>
            <th>Tài khoản</th>
            <th>Biến động</th>
            <th>Lý do</th>
            <th>Tầng lúc đó</th>
            <th class="pe-4 text-end">Ngày tạo</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let tx of transactions">
            <td class="ps-4 fw-semibold text-dark">{{ tx.id }}</td>
            <td>{{ tx.loyalty_account_id }}</td>
            <td [ngClass]="{'text-success fw-semibold': tx.change_amount > 0, 'text-danger fw-semibold': tx.change_amount < 0}">
              {{ tx.change_amount > 0 ? '+' : '' }}{{ tx.change_amount }}
            </td>
            <td>{{ tx.reason }}</td>
            <td>{{ tx.tier_snapshot }}</td>
            <td class="text-end pe-4">{{ tx.created_at | date:'short' }}</td>
          </tr>
          <tr *ngIf="transactions.length === 0">
            <td colspan="6" class="text-center py-4 text-muted">
              <i class="bi bi-inbox text-secondary fs-4 d-block mb-2"></i>
              Không có dữ liệu
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- ==================== MODAL ==================== -->
  <div class="modal fade" tabindex="-1" [ngClass]="{ show: modalOpen }"
    [style.display]="modalOpen ? 'block' : 'none'">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg rounded-4">
        <div class="modal-header bg-body-secondary border-0 rounded-top-4">
          <h5 class="modal-title fw-bold mb-0">
            <i class="bi bi-pencil-square me-2 text-primary"></i>
            {{ editingRule ? 'Sửa quy tắc Loyalty' : 'Thêm quy tắc Loyalty' }}
          </h5>
          <button type="button" class="btn-close" (click)="closeModal()"></button>
        </div>

        <div class="modal-body p-4">
          <form (ngSubmit)="saveRule()">
            <div class="mb-3">
              <label for="tier_name" class="form-label fw-semibold">Tên tầng</label>
              <input id="tier_name" type="text" class="form-control form-control-lg shadow-sm"
                [(ngModel)]="rule.tier_name" name="tier_name" required />
            </div>

            <div class="mb-3">
              <label for="min_points" class="form-label fw-semibold">Điểm tối thiểu</label>
              <input id="min_points" type="number" class="form-control form-control-lg shadow-sm"
                [(ngModel)]="rule.min_points" name="min_points" />
            </div>

            <div class="mb-3">
              <label for="multiplier" class="form-label fw-semibold">Giảm giá (%)</label>
              <input id="multiplier" type="number" class="form-control form-control-lg shadow-sm"
                [(ngModel)]="rule.multiplier" name="multiplier" />
            </div>

            <div class="mb-3">
              <label for="description" class="form-label fw-semibold">Mô tả</label>
              <input id="description" type="text" class="form-control form-control-lg shadow-sm"
                [(ngModel)]="rule.description" name="description" />
            </div>

            <div class="d-flex justify-content-end gap-2 mt-4">
              <button type="submit" class="btn btn-primary px-4">
                <i class="bi bi-check-circle me-1"></i> Lưu
              </button>
              <button type="button" class="btn btn-outline-secondary px-4" (click)="closeModal()">
                <i class="bi bi-x-circle me-1"></i> Hủy
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

</div>
